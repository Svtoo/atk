# ATK Registry Specification

> **Status**: Draft
> **Last Updated**: 2026-01-31

## Overview

The ATK Registry is a curated, git-backed repository of plugins. It enables `atk add <name>` to resolve plugins by name without requiring users to know the source URL.

## Repository Structure

```
atk-registry/
├── plugins/
│   ├── openmemory/
│   │   ├── plugin.yaml
│   │   ├── docker-compose.yml
│   │   └── ...
│   ├── langfuse/
│   │   └── ...
│   └── ...
└── index.yaml              # Auto-generated manifest
```

### Directory Layout

- **Flat structure**: All plugins live directly under `plugins/`
- **One directory per plugin**: Directory name = plugin identifier for `atk add`
- **Self-contained**: Each plugin directory contains all files needed (plugin.yaml, compose files, scripts)

## Index File

`index.yaml` is auto-generated by CI on merge to `main`.

```yaml
# index.yaml
schema_version: "2026-01-31"
plugins:
  - name: openmemory
    path: plugins/openmemory
    description: "Persistent memory layer for AI agents"
  - name: langfuse
    path: plugins/langfuse
    description: "Open-source LLM observability platform"
```

### Index Fields

| Field | Type | Description |
|-------|------|-------------|
| `name` | string | Plugin identifier (directory name) |
| `path` | string | Path within registry repo |
| `description` | string | One-line description (from plugin.yaml) |

## How ATK Uses the Registry

### Resolution Flow

1. User runs `atk add openmemory`
2. ATK fetches `index.yaml` from registry (cached with TTL)
3. ATK looks up `openmemory` in index
4. ATK sparse-checkouts `plugins/openmemory/` from registry
5. ATK copies files to `~/.atk/plugins/openmemory/`
6. ATK records source in manifest:
   ```yaml
   source:
     type: registry
     ref: abc123def  # Commit hash
   ```

### Sparse Checkout

ATK fetches only the specific plugin directory, not the entire registry:

```bash
git clone --filter=blob:none --sparse <registry-url>
git sparse-checkout set plugins/<name>
```

This minimizes bandwidth and disk usage.

## Registry URL

The registry URL is hardcoded in ATK:

```
https://github.com/Svtoo/atk-registry
```

## Versioning

### No Semver

The registry does not use semantic versioning. Versions are tracked by **git commit hash**.

- `atk add` pins to the current `main` HEAD
- `atk upgrade` fetches latest `main` HEAD
- Manifest stores commit hash for reproducibility

### Reproducible Installs

When bootstrapping on a new machine:

1. Manifest contains `source.ref: abc123def`
2. `atk install --all` fetches at that exact commit
3. Result is identical to original install

## Plugin Requirements

Plugins submitted to the registry must:

1. Have a valid `plugin.yaml` (passes schema validation)
2. If `lifecycle.install` is defined, `lifecycle.uninstall` must also be defined
3. Include all required files (compose files, scripts referenced in lifecycle)

## CI Workflow

On merge to `main`:

1. Validate all plugins pass schema validation
2. Regenerate `index.yaml` from plugin directories
3. Commit and push `index.yaml` if changed

```yaml
# .github/workflows/generate-index.yml
name: Generate Index
on:
  push:
    branches: [main]
jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Generate index.yaml
        run: ./scripts/generate-index.sh
      - name: Commit index
        run: |
          git add index.yaml
          git diff --cached --quiet || git commit -m "Update index.yaml"
          git push
```

## Contributing Plugins

TODO:
- Add tool to create new plugin from template
- Add tool to validate plugin
- Add detailed instructions in readme to contribute

## Cache Strategy

ATK caches `index.yaml` locally:

- **Location**: `<ATK_HOME>/.registry/index.yaml`
- **TTL**: 1 hour (configurable)
- **Force refresh**: `atk add --refresh <name>` (future)

## Error Handling

| Error                      | Message                                                                   |
|----------------------------|---------------------------------------------------------------------------|
| Plugin not in registry     | `Plugin '<name>' not found in registry. Check spelling or use a git URL.` |
| Network unavailable        | `Cannot reach registry. Check your internet connection.`                  |
| Invalid plugin in registry | `Registry plugin '<name>' failed validation. This is a registry bug.`     |

## Out of Scope

- **Private registries**: Single public registry for MVP
- **Search command**: `atk search <query>` deferred to Phase 5
- **Multiple registries**: No registry list or priority
- **Plugin ratings/stats**: No popularity metrics

